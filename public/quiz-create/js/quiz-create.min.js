jQuery(document).ready(function(e){function n(n){var o,i;e.ajax({type:"POST",url:quizCreate.ajax_url,data:{action:"save_quiz",quiz:e(".enp-quiz-form").serialize(),quizSubmit:n},beforeSend:function(e){console.log("Before send",e)}}).done(function(n,s,u){if(console.log(u.responseJSON),n=e.parseJSON(u.responseJSON),o=n.user_action.action,i=n.user_action.element,"success"===n.status&&"insert"===n.action)t(n);else if("add"==o&&"question"==i){var p=f(n.question);p!==!1&&void 0!==p.question_id&&parseInt(p.question_id)>0?(new_questionID=p.question_id,_=x(new_questionID,n.question),v(new_questionID,_)):q()}else if("delete"==o&&"question"==i)questionID=n.user_action.details.question_id,questionResponse=b(questionID,n.question),questionResponse!==!1&&"update"===questionResponse.action&&"success"===questionResponse.status?c(questionID):r(questionID);else if("delete"==o&&"mc_option"==i){var d=n.user_action.details.mc_option_id;mcOptionResponse=C(d,n.question),mcOptionResponse!==!1&&"update"===mcOptionResponse.action&&"success"===mcOptionResponse.status?l(d):m(d)}else if("add"==o&&"mc_option"==i){questionID=n.user_action.details.question_id;var _=x(questionID,n.question);D(_,questionID)}else"set_correct"==o&&"mc_option"==i&&I(n.user_action.details.mc_option_id,n.user_action.details.question_id);a(n.message)}).fail(function(e,n,t){console.log("AJAX failed",e.getAllResponseHeaders(),n,t)}).then(function(e,n,t){console.log("AJAX after finished")}).always(function(){s()})}function t(n){e("#enp-quiz-id").val(n.quiz_id);var t=e("body").innerHTML,o=e(".enp-quiz-title__textarea").val();o="Quiz: "+o;var i=quizCreate.quiz_create_url+n.quiz_id;window.history.pushState({html:t,pageTitle:o},"",i)}function o(e){var n;if(console.log(e),e.indexOf("add-question")>-1)_();else if(e.indexOf("add-mc-option__question")>-1)n=/add-mc-option__question-/g,questionID=e.replace(n,""),w(questionID);else if(e.indexOf("question--delete")>-1)n=/question--delete-/g,questionID=e.replace(n,""),p(questionID);else if(e.indexOf("mc-option--delete")>-1){n=/mc-option--delete-/g;var t=e.replace(n,"");d(t)}}function i(){e(".enp-quiz-message-ajax-container").append('<p class="enp-quiz-message--saving">Saving...</p>'),e(".enp-quiz-submit").addClass("enp-quiz-submit--wait")}function s(){e(".enp-quiz-submit").removeClass("enp-quiz-submit--wait"),e(".enp-quiz-message--saving").remove()}function a(e){u(e.success[0],"success");for(var n=0;n<e.error.length;n++)u(e.error[n],"error")}function u(n,t){var o=Math.floor(1e3*Math.random()+1);e(".enp-quiz-message-ajax-container").append('<div class="enp-quiz-message enp-quiz-message--ajax enp-quiz-message--'+t+" enp-container enp-message-"+o+'"><p class="enp-message__list enp-message__list--'+t+'">'+n+"</p></div>"),e(".enp-message-"+o).delay(3500).fadeOut(function(){e(".enp-message-"+o).fadeOut()})}function p(n){var t,o;t=e("#enp-question--"+n).prev(".enp-accordion-header"),t.addClass("enp-question--remove"),o=e("#enp-question--"+n),o.next().focus(),o.addClass("enp-question--remove")}function r(n){var t;t=e("#enp-question--"+n).prev(".enp-accordion-header"),t.removeClass("enp-question--remove"),e("#enp-question--"+n).removeClass("enp-question--remove"),u("Question could not be deleted. Please reload the page and try again.","error")}function c(n){e("#enp-question--"+n).prev(".enp-accordion-header").remove(),e("#enp-question--"+n).remove(),u("Question deleted.","success")}function d(n){var t;t=e("#enp-mc-option--"+n),t.next(".enp-mc-option").find("button:first").focus(),t.addClass("enp-mc-option--remove")}function l(n){e("#enp-mc-option--"+n).remove()}function m(n){var t;t=e("#enp-mc-option--"+n),t.removeClass("enp-mc-option--remove"),e(".enp-mc-option__button--delete",t).focus(),u("Multiple Choice Option could not be deleted. Please reload the page and try again.","error")}function _(){var n,t,o,i;t=e("#enp-question--questionTemplateID__accordion-header"),n=e("#enp-question--questionTemplateID"),i=t.clone(),o=n.clone(),i.attr("id","enp-question--newQuestionTemplateID__accordion-header"),o.attr("id","enp-question--newQuestionTemplateID"),o.insertBefore(t),i.insertBefore(o)}function q(){e("#enp-question--newQuestionTemplateID__accordion-header").remove(),e("#enp-question--newQuestionTemplateID").remove(),u("Question could not be added. Please reload the page and try again.","error")}function f(e){for(var n in e)if("insert"===e[n].action)return e[n];return!1}function v(n,t){var o,i;console.log(n),i=e("#enp-question--newQuestionTemplateID__accordion-header"),o=e("#enp-question--newQuestionTemplateID"),g(i,"id",n,/newQuestionTemplateID/),g(o,"id",n,/newQuestionTemplateID/),h(e(".enp-question-id",o),n),h(e(".enp-question__button--delete",o),n),g(e(".enp-question-image-upload",o),"for",n),g(e(".enp-question-image-upload__input",o),"id",n),g(e(".enp-question-image-upload__input",o),"name",n),h(e(".enp-mc-option__button--correct",o),n),h(e(".enp-mc-option__add",o),n)}function g(e,n,t,o){o="undefined"!=typeof o?o:/questionTemplateID/,newAttrVal=e.attr(n).replace(o,t),e.attr(n,newAttrVal)}function h(e,n,t){t="undefined"!=typeof t?t:/questionTemplateID/,newObjVal=e.val().replace(t,n),e.val(newObjVal)}function I(n,t){return e("#enp-mc-option--"+n).hasClass("enp-mc-option--correct")?(e("#enp-mc-option--"+n).removeClass("enp-mc-option--correct"),!1):(e("#enp-question--"+t+" .enp-mc-option").removeClass("enp-mc-option--correct"),void e("#enp-mc-option--"+n).addClass("enp-mc-option--correct"))}function w(n){var t=e("#enp-question--questionTemplateID .enp-mc-option:first").clone();t.insertBefore(e("#enp-question--"+n+" .enp-mc-option--add")),e("#enp-question--"+n+" #enp-mc-option--MCOptionTemplate").focus()}function D(n,t){var o;o=e("#enp-question--"+t+" #enp-mc-option--mcOptionTemplateID"),e(".enp-mc-option-id",o).val(n),e(".enp-mc-option__button--delete",o).val("mc-option--delete-"+n),e(".enp-mc-option__button--correct",o).val("mc-option--correct__question-"+t+"__mc-option-"+n),e(o).attr("id","enp-mc-option--"+n),question_index=z(t),question_index_pattern=/enp_question\[(.*?)\]/,mc_option_pattern=/\[mc_option\]\[(.*?)\]/,new_mc_option_index=e("#enp-question--"+t+" .enp-mc-option__input").length-1,e("input",o).each(function(){var n=e(this).prop("name");new_inputName=n.replace(question_index_pattern,"enp_question["+question_index+"]"),e(this).attr("name",new_inputName),n=e(this).prop("name"),new_inputName=n.replace(mc_option_pattern,"[mc_option]["+new_mc_option_index+"]"),console.log(new_inputName),e(this).attr("name",new_inputName)})}function z(n){return e(".enp-question-content").each(function(t){return parseInt(e(".enp-question-id",this).val())===parseInt(n)?(questionIndex=t,!1):void 0}),questionIndex}function x(e,n){for(var t in n)if(parseInt(n[t].question_id)===parseInt(e))for(var o in n[t].mc_option)if(console.log(n[t].mc_option[o]),"insert"===n[t].mc_option[o].action)return n[t].mc_option[o].mc_option_id;return!1}function b(e,n){for(var t in n)if(parseInt(n[t].question_id)===parseInt(e))return console.log(n[t]),n[t];return!1}function C(e,n){for(var t in n)for(var o in n[t].mc_option)if(parseInt(n[t].mc_option[o].mc_option_id)===parseInt(e))return n[t].mc_option[o];return!1}e(".enp-question-content").each(function(){var n,t,o;t=e(".enp-question-title__textarea",this).val(),(void 0===t||""===t)&&(t="Untitled"),o=e(this),n={title:t,content:o,baseID:e(this).attr("id")},n=enp_accordion__create_headers(n),enp_accordion__setup(n)}),e(document).on("keyup",".enp-question-title__textarea",function(){question_title=e(this).val(),e(this).closest(".enp-question-content").prev(".enp-accordion-header").text(question_title)}),e(document).on("click",".enp-quiz-submit",function(t){if(!e(this).hasClass("enp-btn--next-step")){if(t.preventDefault(),e(this).hasClass("enp-question__button--delete")){var s=confirm("Are you sure you want to delete this question?");if(s===!1)return!1}if(e(this).hasClass("enp-quiz-submit--wait"))return console.log("waiting..."),!1;i();var a=e(this).val();o(a),n(a)}}),e("#enp-quiz").append('<section class="enp-quiz-message-ajax-container"></section>')});