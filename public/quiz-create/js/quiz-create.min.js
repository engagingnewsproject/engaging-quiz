jQuery(document).ready(function(e){function n(n){var t,o,u=document.getElementById("enp-quiz-create-form"),p=new FormData(u);p.append("enp-quiz-submit",n),p.append("action","save_quiz"),e.ajax({type:"POST",url:quizCreate.ajax_url,data:p,processData:!1,contentType:!1,beforeSend:function(e){console.log("Before send",e)}}).done(function(n,s,u){if(console.log(u.responseJSON),n=e.parseJSON(u.responseJSON),t=n.user_action.action,o=n.user_action.element,"success"===n.status&&"insert"===n.action&&i(n),"add"==t&&"question"==o){var p=g(n.question);p!==!1&&void 0!==p.question_id&&parseInt(p.question_id)>0?(new_questionID=p.question_id,new_mcOption=z(new_questionID,n.question),f(new_questionID,new_mcOption.mc_option_id)):_()}else if("delete"==t&&"question"==o)questionID=n.user_action.details.question_id,questionResponse=C(questionID,n.question),questionResponse!==!1&&"update"===questionResponse.action&&"success"===questionResponse.status?c(questionID):r(questionID);else if("delete"==t&&"mc_option"==o){var m=n.user_action.details.mc_option_id;mcOptionResponse=O(m,n.question),mcOptionResponse!==!1&&"update"===mcOptionResponse.action&&"success"===mcOptionResponse.status?l(m):q(m)}else if("add"==t&&"mc_option"==o){questionID=n.user_action.details.question_id;var d=z(questionID,n.question);d!==!1&&void 0!==d.mc_option_id&&parseInt(d.mc_option_id)>0?w(d.mc_option_id,questionID):b(questionID)}else"set_correct"==t&&"mc_option"==o?D(n.user_action.details.mc_option_id,n.user_action.details.question_id):"upload"==t&&"question_image"==o?(questionID=n.user_action.details.question_id,questionResponse=C(questionID,n.question),questionResponse!==!1&&"update"===questionResponse.action&&"success"===questionResponse.status?y(questionResponse):temp_unsetAddQuestionImage(questionID)):"delete"==t&&"question_image"==o&&(questionID=n.user_action.details.question_id,questionResponse=C(questionID,n.question),questionResponse!==!1&&"update"===questionResponse.action&&"success"===questionResponse.status?S(questionResponse):F(questionID));a(n.message)}).fail(function(e,n,i){console.log("AJAX failed",e.getAllResponseHeaders(),n,i)}).then(function(e,n,i){console.log("AJAX after finished")}).always(function(){s()})}function i(n){e("#enp-quiz-id").val(n.quiz_id);var i=e("body").innerHTML,t=e(".enp-quiz-title__textarea").val();t="Quiz: "+t;var o=quizCreate.quiz_create_url+n.quiz_id;window.history.pushState({html:i,pageTitle:t},"",o)}function t(e){var n;console.log(e),e.indexOf("add-question")>-1?d():e.indexOf("add-mc-option__question")>-1?(n=/add-mc-option__question-/g,questionID=e.replace(n,""),h(questionID)):e.indexOf("question--delete")>-1?(n=/question--delete-/g,questionID=e.replace(n,""),p(questionID)):e.indexOf("mc-option--delete")>-1?(n=/mc-option--delete-/g,mcOptionID=e.replace(n,""),m(mcOptionID)):e.indexOf("question-image--upload")>-1?(n=/question-image--upload-/g,questionID=e.replace(n,""),console.log(questionID),T(questionID)):e.indexOf("question-image--delete")>-1&&(n=/question-image--delete-/g,questionID=e.replace(n,""),console.log(questionID),R(questionID))}function o(){e(".enp-quiz-message-ajax-container").append('<p class="enp-quiz-message--saving">Saving...</p>'),e(".enp-quiz-submit").addClass("enp-quiz-submit--wait")}function s(){e(".enp-quiz-submit").removeClass("enp-quiz-submit--wait"),e(".enp-quiz-message--saving").remove()}function a(e){for(var n=0;n<e.success.length;n++)u(e.success[n],"success");for(var i=0;i<e.error.length;i++)u(e.error[i],"error")}function u(n,i){var t=Math.floor(1e3*Math.random()+1);e(".enp-quiz-message-ajax-container").append('<div class="enp-quiz-message enp-quiz-message--ajax enp-quiz-message--'+i+" enp-container enp-message-"+t+'"><p class="enp-message__list enp-message__list--'+i+'">'+n+"</p></div>"),e(".enp-message-"+t).delay(3500).fadeOut(function(){e(".enp-message-"+t).fadeOut()})}function p(n){var i,t;i=e("#enp-question--"+n).prev(".enp-accordion-header"),i.addClass("enp-question--remove"),t=e("#enp-question--"+n),t.next().focus(),t.addClass("enp-question--remove")}function r(n){var i;i=e("#enp-question--"+n).prev(".enp-accordion-header"),i.removeClass("enp-question--remove"),e("#enp-question--"+n).removeClass("enp-question--remove"),u("Question could not be deleted. Please reload the page and try again.","error")}function c(n){e("#enp-question--"+n).prev(".enp-accordion-header").remove(),e("#enp-question--"+n).remove()}function m(n){var i;i=e("#enp-mc-option--"+n),i.next(".enp-mc-option").find("button:first").focus(),i.addClass("enp-mc-option--remove")}function l(n){e("#enp-mc-option--"+n).remove()}function q(n){var i;i=e("#enp-mc-option--"+n),i.removeClass("enp-mc-option--remove"),e(".enp-mc-option__button--delete",i).focus(),u("Multiple Choice Option could not be deleted. Please reload the page and try again.","error")}function d(){var n,i,t,o;i=e("#enp-question--questionTemplateID__accordion-header"),n=e("#enp-question--questionTemplateID"),o=i.clone(),t=n.clone(),o.attr("id","enp-question--newQuestionTemplateID__accordion-header"),t.attr("id","enp-question--newQuestionTemplateID"),e(".enp-question-image__container",t).remove(),t.insertBefore(i),o.insertBefore(t)}function _(){e("#enp-question--newQuestionTemplateID__accordion-header").remove(),e("#enp-question--newQuestionTemplateID").remove(),u("Question could not be added. Please reload the page and try again.","error")}function g(e){for(var n in e)if("insert"===e[n].action)return e[n];return!1}function f(n,i){var t,o;o=e("#enp-question--newQuestionTemplateID__accordion-header"),t=e("#enp-question--newQuestionTemplateID"),v(o,"id",n,/newQuestionTemplateID/),v(t,"id",n,/newQuestionTemplateID/),I(e(".enp-question-id",t),n),I(e(".enp-question__button--delete",t),n),v(e(".enp-question-image__input",t),"id",n),v(e(".enp-question-image-upload",t),"for",n),v(e(".enp-question-image-upload__input",t),"id",n),v(e(".enp-question-image-upload__input",t),"name",n),I(e(".enp-button__question-image-upload",t),n),v(e(".enp-question-type__input--slider",t),"id",n),v(e(".enp-question-type__label--slider",t),"for",n),v(e(".enp-question-type__input--mc",t),"id",n),v(e(".enp-question-type__label--mc",t),"for",n),I(e(".enp-mc-option__button--correct",t),n),I(e(".enp-mc-option__add",t),n),w(i,n),question_index=x(n),question_index_pattern=/enp_question\[questionCounterTemplate\]/,e("input, textarea",t).each(function(){var n=e(this).prop("name");new_inputName=n.replace(question_index_pattern,"enp_question["+question_index+"]"),e(this).attr("name",new_inputName)})}function v(e,n,i,t){t="undefined"!=typeof t?t:/questionTemplateID/,newAttrVal=e.attr(n).replace(t,i),e.attr(n,newAttrVal)}function I(e,n,i){i="undefined"!=typeof i?i:/questionTemplateID/,newObjVal=e.val().replace(i,n),e.val(newObjVal)}function D(n,i){return e("#enp-mc-option--"+n).hasClass("enp-mc-option--correct")?(e("#enp-mc-option--"+n).removeClass("enp-mc-option--correct"),!1):(e("#enp-question--"+i+" .enp-mc-option").removeClass("enp-mc-option--correct"),void e("#enp-mc-option--"+n).addClass("enp-mc-option--correct"))}function h(n){var i=e("#enp-question--questionTemplateID .enp-mc-option:first").clone();i.insertBefore(e("#enp-question--"+n+" .enp-mc-option--add")),e("#enp-question--"+n+" .enp-mc-option--inputs:last .enp-mc-option__input").focus()}function b(n){e("#enp-question--"+n+" #enp-mc-option--mcOptionTemplateID").remove(),u("Multiple Choice Option could not be added. Please reload the page and try again.","error")}function w(n,i){var t;t=e("#enp-question--"+i+" #enp-mc-option--mcOptionTemplateID"),e(".enp-mc-option-id",t).val(n),e(".enp-mc-option__button--delete",t).val("mc-option--delete-"+n),e(".enp-mc-option__button--correct",t).val("mc-option--correct__question-"+i+"__mc-option-"+n),e(t).attr("id","enp-mc-option--"+n),question_index=x(i),question_index_pattern=/enp_question\[(.*?)\]/,mc_option_pattern=/\[mc_option\]\[(.*?)\]/,new_mc_option_index=e("#enp-question--"+i+" .enp-mc-option__input").length-1,e("input",t).each(function(){var n=e(this).prop("name");new_inputName=n.replace(question_index_pattern,"enp_question["+question_index+"]"),e(this).attr("name",new_inputName),n=e(this).prop("name"),new_inputName=n.replace(mc_option_pattern,"[mc_option]["+new_mc_option_index+"]"),console.log(new_inputName),e(this).attr("name",new_inputName)})}function x(n){return e(".enp-question-content").each(function(i){return parseInt(e(".enp-question-id",this).val())===parseInt(n)?(questionIndex=i,!1):void 0}),questionIndex}function z(e,n){for(var i in n)if(parseInt(n[i].question_id)===parseInt(e))for(var t in n[i].mc_option)if(console.log(n[i].mc_option[t]),"insert"===n[i].mc_option[t].action)return n[i].mc_option[t];return!1}function C(e,n){for(var i in n)if(parseInt(n[i].question_id)===parseInt(e))return console.log(n[i]),n[i];return!1}function O(e,n){for(var i in n)for(var t in n[i].mc_option)if(parseInt(n[i].mc_option[t].mc_option_id)===parseInt(e))return n[i].mc_option[t];return!1}function T(n){e("#enp-question--"+questionID+" .enp-question-image-upload").hide(),e("#enp-question--"+questionID+" .enp-question-image-upload").after('<div class="spinner enp-image-upload-wait"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>')}function y(n){questionID=n.question_id,e("#enp-question--"+questionID+" .enp-question-image-upload").remove(),e("#enp-question--"+questionID+" .enp-question-image-upload__input").remove(),e("#enp-question--"+questionID+" .enp-image-upload-wait").remove(),e("#enp-question--"+questionID+" .enp-question-image__input").val(n.question_image),newImageContainer=e("#enp-question--questionTemplateID .enp-question-image__container").clone(),imageFile=n.question_image,console.log(imageFile),imageFile=imageFile.replace(/-original/g,"580w"),imageURL=quizCreate.quiz_image_url+e("#enp-quiz-id").val()+"/"+questionID+"/"+imageFile,newImageContainer.prepend('<img class="enp-question-image enp-question-image" src="'+imageURL+'" alt="'+n.question_image_alt+'"/>'),I(e(".enp-button__question-image-delete",newImageContainer),questionID),e("#enp-question--"+questionID+" .enp-question-image__input").after(newImageContainer)}function R(n){e("#enp-question--"+n+" .enp-question-image__container").addClass("enp-question__image--remove"),imageInput=e("#enp-question-image-"+n),imageFilename=imageInput.val(),imageInput.data("image_filename",imageFilename),imageInput.val(""),console.log("old value is "+imageInput.data("image_filename"))}function F(n){e("#enp-question--"+n+" .enp-question-image__container").removeClass("enp-question__image--remove"),oldImageFilename=e("#enp-question-image-"+n).data("image_filename"),e("#enp-question-image-"+n).val(oldImageFilename),u("Image could not be deleted. Please reload the page and try again.","error")}function S(n){questionID=n.question_id,e("#enp-question--"+questionID+" .enp-question-image__container").remove(),e("#enp-question--"+questionID+" .enp-question-image__input").val(""),imageLabel=e("#enp-question--questionTemplateID .enp-question-image-upload").clone(),v(imageLabel,"for",questionID),imageUpload=e("#enp-question--questionTemplateID .enp-button__question-image-upload").clone(),I(imageUpload,questionID),imageFileSelect=e("#enp-question--questionTemplateID .enp-question-image-upload__input").clone(),v(imageFileSelect,"name",questionID),v(imageFileSelect,"id",questionID),imageUpload.insertAfter("#enp-question--"+questionID+" .enp-question-image__input"),imageFileSelect.insertAfter("#enp-question--"+questionID+" .enp-question-image__input"),imageLabel.insertAfter("#enp-question--"+questionID+" .enp-question-image__input"),imageFile=n.question_image,console.log("image deleted "+imageFile)}e(".enp-question-content").each(function(){var n,i,t;i=e(".enp-question-title__textarea",this).val(),(void 0===i||""===i)&&(i="Untitled"),t=e(this),n={title:i,content:t,baseID:e(this).attr("id")},n=enp_accordion__create_headers(n),enp_accordion__setup(n)}),e(".enp-button__question-image-upload, .enp-question-image-upload__input").hide(),e(document).on("keyup",".enp-question-title__textarea",function(){question_title=e(this).val(),e(this).closest(".enp-question-content").prev(".enp-accordion-header").text(question_title)}),e(document).on("click",".enp-quiz-submit",function(i){if(!e(this).hasClass("enp-btn--next-step")){if(i.preventDefault(),e(this).hasClass("enp-question__button--delete")){var s=confirm("Are you sure you want to delete this question?");if(s===!1)return!1}if(e(this).hasClass("enp-quiz-submit--wait"))return console.log("waiting..."),!1;o();var a=e(this).val();t(a),n(a)}}),e("#enp-quiz").append('<section class="enp-quiz-message-ajax-container"></section>'),e("document").on("click",".enp-question-image-upload",function(){imageLabel=e(this),imageInput=imageLabel.siblings(".enp-question-image__input"),imageSubmit=imageLabel.siblings(".enp-button__question-image-upload"),oldImageSubmit=imageSubmit.val(),imageInput.trigger("click")}),e(document).on("change",".enp-question-image-upload__input",function(){console.log("the image to be uploaded is"+e(this).val()),imageSubmit=e(this).siblings(".enp-button__question-image-upload"),imageSubmit.trigger("click")})});