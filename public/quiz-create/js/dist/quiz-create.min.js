jQuery(document).ready(function(e){function n(n){var t,i,o;i=e(".enp-question-title__textarea",n).val(),(void 0===i||""===i)&&(i="Question"),o=n,t={title:i,content:o,baseID:n.attr("id")},t=enp_accordion__create_headers(t),enp_accordion__setup(t)}function t(n){var t=document.getElementById("enp-quiz-create-form"),o=new FormData(t);o.append("enp-quiz-submit",n),o.append("action","save_quiz"),s(n),e.ajax({type:"POST",url:quizCreate.ajax_url,data:o,processData:!1,contentType:!1}).done(i).fail(function(e,n,t){console.log("AJAX failed",e.getAllResponseHeaders(),n,t)}).then(function(e,n,t){console.log("AJAX after finished")}).always(function(){u()})}function i(n,t,i){if(console.log(i.responseJSON),void 0===i.responseJSON)return u(),r("Something went wrong. Please reload the page and try again.","error"),!1;if(n=e.parseJSON(i.responseJSON),userActionAction=n.user_action.action,userActionElement=n.user_action.element,"success"===n.status&&"insert"===n.action&&o(n),"add"==userActionAction&&"question"==userActionElement){var s=I(n.question);s!==!1&&void 0!==s.question_id&&parseInt(s.question_id)>0?(new_questionID=s.question_id,new_mcOption=O(new_questionID,n.question),D(new_questionID,new_mcOption.mc_option_id)):v()}else if("delete"==userActionAction&&"question"==userActionElement)questionID=n.user_action.details.question_id,questionResponse=C(questionID,n.question),questionResponse!==!1&&"update"===questionResponse.action&&"success"===questionResponse.status?m(questionID):l(questionID);else if("delete"==userActionAction&&"mc_option"==userActionElement){var a=n.user_action.details.mc_option_id;mcOptionResponse=x(a,n.question),mcOptionResponse!==!1&&"update"===mcOptionResponse.action&&"success"===mcOptionResponse.status?q(a):g(a)}else if("add"==userActionAction&&"mc_option"==userActionElement){questionID=n.user_action.details.question_id;var c=O(questionID,n.question);c!==!1&&void 0!==c.mc_option_id&&parseInt(c.mc_option_id)>0?z(c.mc_option_id,questionID):b(questionID)}else"set_correct"==userActionAction&&"mc_option"==userActionElement?h(n.user_action.details.mc_option_id,n.user_action.details.question_id):"upload"==userActionAction&&"question_image"==userActionElement?(questionID=n.user_action.details.question_id,questionResponse=C(questionID,n.question),questionResponse!==!1&&"update"===questionResponse.action&&"success"===questionResponse.status?R(questionResponse):temp_unsetAddQuestionImage(questionID)):"delete"==userActionAction&&"question_image"==userActionElement&&(questionID=n.user_action.details.question_id,questionResponse=C(questionID,n.question),questionResponse!==!1&&"update"===questionResponse.action&&"success"===questionResponse.status?S(questionResponse):T(questionID));p(n.message)}function o(n){e("#enp-quiz-id").val(n.quiz_id);var t=e("body").innerHTML,i=e(".enp-quiz-title__textarea").val();i="Quiz: "+i;var o=quizCreate.quiz_create_url+n.quiz_id;window.history.pushState({html:t,pageTitle:i},"",o)}function s(e){var n;console.log(e),e.indexOf("add-question")>-1?f():e.indexOf("add-mc-option__question")>-1?(n=/add-mc-option__question-/g,questionID=e.replace(n,""),w(questionID)):e.indexOf("question--delete")>-1?(n=/question--delete-/g,questionID=e.replace(n,""),c(questionID)):e.indexOf("mc-option--delete")>-1?(n=/mc-option--delete-/g,mcOptionID=e.replace(n,""),d(mcOptionID)):e.indexOf("question-image--upload")>-1?(n=/question-image--upload-/g,questionID=e.replace(n,""),console.log(questionID),Q(questionID)):e.indexOf("question-image--delete")>-1&&(n=/question-image--delete-/g,questionID=e.replace(n,""),console.log(questionID),P(questionID))}function a(){e(".enp-quiz-message-ajax-container").append('<div class="enp-quiz-message--saving">'+y("enp-quiz-message--saving__spinner")+'<div class="enp-quiz-message--saving__text">Saving</div></div>'),e(".enp-quiz-submit").addClass("enp-quiz-submit--wait")}function u(){e(".enp-quiz-submit").removeClass("enp-quiz-submit--wait"),e(".enp-quiz-message--saving").remove()}function p(e){"undefined"!=typeof e.success&&e.success.length>0&&r("Quiz Saved.","success");for(var n=0;n<e.error.length;n++)r(e.error[n],"error")}function r(n,t){var i=Math.floor(1e3*Math.random()+1);e(".enp-quiz-message-ajax-container").append('<div class="enp-quiz-message enp-quiz-message--ajax enp-quiz-message--'+t+" enp-container enp-message-"+i+'"><p class="enp-message__list enp-message__list--'+t+'">'+n+"</p></div>"),e(".enp-message-"+i).delay(3500).fadeOut(function(){e(".enp-message-"+i).fadeOut()})}function c(n){var t,i;t=e("#enp-question--"+n).prev(".enp-accordion-header"),t.addClass("enp-question--remove"),i=e("#enp-question--"+n),i.next().focus(),i.addClass("enp-question--remove")}function l(n){var t;t=e("#enp-question--"+n).prev(".enp-accordion-header"),t.removeClass("enp-question--remove"),e("#enp-question--"+n).removeClass("enp-question--remove"),r("Question could not be deleted. Please reload the page and try again.","error")}function m(n){e("#enp-question--"+n).prev(".enp-accordion-header").remove(),e("#enp-question--"+n).remove()}function d(n){var t;t=e("#enp-mc-option--"+n),t.next(".enp-mc-option").find("button:first").focus(),t.addClass("enp-mc-option--remove")}function q(n){e("#enp-mc-option--"+n).remove()}function g(n){var t;t=e("#enp-mc-option--"+n),t.removeClass("enp-mc-option--remove"),e(".enp-mc-option__button--delete",t).focus(),r("Multiple Choice Option could not be deleted. Please reload the page and try again.","error")}function f(){templateParams={question_id:"newQuestionTemplateID",question_position:"newQuestionPosition"},e(".enp-quiz-form__add-question").before(j(templateParams)),newQuestion=e("#enp-question--newQuestionTemplateID"),e(".enp-question-image-alt__label",newQuestion).before(J(templateParams)),e(".enp-image-upload__label, .enp-button__question-image-upload, .enp-question-image-upload__input",newQuestion).hide(),e(".enp-question-image__input",newQuestion).after(V()),w("newQuestionTemplateID"),n(e("#enp-question--newQuestionTemplateID")),e("#enp-question--newQuestionTemplateID__accordion-header").focus()}function v(){e("#enp-question--newQuestionTemplateID__accordion-header").remove(),e("#enp-question--newQuestionTemplateID").remove(),r("Question could not be added. Please reload the page and try again.","error")}function I(e){for(var n in e)if("insert"===e[n].action)return e[n];return!1}function D(e,n){E(document.getElementById("enp-question--newQuestionTemplateID"),/newQuestionTemplateID/,e),E(document.getElementById("enp-question--newQuestionTemplateID__accordion-header"),/newQuestionTemplateID/,e),E(document.getElementById("enp-question--"+e),/newQuestionPosition/,A(e)),z(n,e)}function h(n,t){return e("#enp-mc-option--"+n).hasClass("enp-mc-option--correct")?(e("#enp-mc-option--"+n).removeClass("enp-mc-option--correct"),!1):(e("#enp-question--"+t+" .enp-mc-option").removeClass("enp-mc-option--correct"),void e("#enp-mc-option--"+n).addClass("enp-mc-option--correct"))}function w(n){temp_mc_option=k({question_id:n,question_position:"newQuestionPosition",mc_option_id:"newMCOptionID",mc_option_position:"newMCOptionPosition"}),e("#enp-question--"+n+" .enp-mc-option--add").before(temp_mc_option),e("#enp-question--"+n+" .enp-mc-option--inputs:last .enp-mc-option__input").focus()}function b(n){e("#enp-question--"+n+" #enp-mc-option--newMCOptionID").remove(),r("Multiple Choice Option could not be added. Please reload the page and try again.","error")}function z(n,t){new_mcOption_el=document.querySelector("#enp-question--"+t+" #enp-mc-option--newMCOptionID"),E(new_mcOption_el,/newQuestionPosition/,A(t)),new_mc_option_index=e("#enp-question--"+t+" .enp-mc-option--inputs").length-1,E(new_mcOption_el,/newMCOptionPosition/,new_mc_option_index),E(new_mcOption_el,/newMCOptionID/,n)}function A(n){return e(".enp-question-content").each(function(t){return parseInt(e(".enp-question-id",this).val())===parseInt(n)?(questionIndex=t,!1):void 0}),questionIndex}function O(e,n){for(var t in n)if(parseInt(n[t].question_id)===parseInt(e))for(var i in n[t].mc_option)if(console.log(n[t].mc_option[i]),"insert"===n[t].mc_option[i].action)return n[t].mc_option[i];return!1}function C(e,n){for(var t in n)if(parseInt(n[t].question_id)===parseInt(e))return console.log(n[t]),n[t];return!1}function x(e,n){for(var t in n)for(var i in n[t].mc_option)if(parseInt(n[t].mc_option[i].mc_option_id)===parseInt(e))return n[t].mc_option[i];return!1}function Q(n){e("#enp-question--"+questionID+" .enp-question-image-upload").hide(),e("#enp-question--"+questionID+" .enp-question-image-upload").after(y("enp-image-upload-wait"))}function y(e){return'<div class="spinner '+e+'"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>'}function R(n){questionID=n.question_id,e("#enp-question--"+questionID+" .enp-question-image-upload").remove(),e("#enp-question--"+questionID+" .enp-question-image-upload__input").remove(),e("#enp-question--"+questionID+" .enp-image-upload-wait").remove(),e("#enp-question--"+questionID+" .enp-question-image__input").val(n.question_image),templateParams={question_id:questionID,question_position:A(questionID)},e("#enp-question--"+questionID+" .enp-question-image__input").after(N(templateParams)),imageFile=n.question_image,imageFile=imageFile.replace(/-original/g,"580w"),imageURL=quizCreate.quiz_image_url+e("#enp-quiz-id").val()+"/"+questionID+"/"+imageFile,e("#enp-question--"+questionID+" .enp-question-image__container").prepend('<img class="enp-question-image enp-question-image" src="'+imageURL+'" alt="'+n.question_image_alt+'"/>')}function P(n){e("#enp-question--"+n+" .enp-question-image__container").addClass("enp-question__image--remove"),imageInput=e("#enp-question-image-"+n),imageFilename=imageInput.val(),imageInput.data("image_filename",imageFilename),imageInput.val(""),console.log("old value is "+imageInput.data("image_filename"))}function T(n){e("#enp-question--"+n+" .enp-question-image__container").removeClass("enp-question__image--remove"),oldImageFilename=e("#enp-question-image-"+n).data("image_filename"),e("#enp-question-image-"+n).val(oldImageFilename),r("Image could not be deleted. Please reload the page and try again.","error")}function S(n){questionID=n.question_id,n=e("#enp-question--"+questionID),e(".enp-question-image__container",n).remove(),e(".enp-question-image__input",n).val(""),templateParams={question_id:questionID,question_position:A(questionID)},e(".enp-question-image__input",n).after(J(templateParams)),e(".enp-image-upload__label, .enp-button__question-image-upload, .enp-question-image-upload__input",n).hide(),e(".enp-question-image__input",n).after(V()),e(".enp-question-image-upload",n).focus()}function E(e,n,t){F(e,n,t),e.children&&M(e.children,n,t)}function M(e,n,t){for(var i,o=0;o<e.length;o++)i=e[o],F(i,n,t),i.children&&M(i.children,n,t)}function F(n,t,i){for(var o,s=0,a=n.attributes,u=a.length;u>s;s++)o=a[s],newAttrVal=o.nodeValue.replace(t,i),newAttrVal!==o.nodeValue&&("value"===o.nodeName?e(n).val(newAttrVal):n.setAttribute(o.nodeName,newAttrVal),console.log("Replaced "+o.nodeName+" "+o.nodeValue))}e(".enp-image-upload__label, .enp-button__question-image-upload, .enp-question-image-upload__input").hide(),e(document).on("keyup",".enp-question-title__textarea",function(){question_title=e(this).val(),e(this).closest(".enp-question-content").prev(".enp-accordion-header").text(question_title)}),e(document).on("click",".enp-quiz-submit",function(n){if(!e(this).hasClass("enp-btn--next-step")){if(n.preventDefault(),"1"===e("#enp-quiz-new").val()&&""===e(".enp-quiz-title__textarea").val())return e(".enp-quiz-title__textarea").focus(),r("Please enter a title for your quiz.","error"),!1;if(e(this).hasClass("enp-question__button--delete")){var i=confirm("Are you sure you want to delete this question?");if(i===!1)return!1}if(e(this).hasClass("enp-quiz-submit--wait"))return console.log("waiting..."),!1;a();var o=e(this).val();t(o)}}),e("#enp-quiz").append('<section class="enp-quiz-message-ajax-container"></section>'),e(document).on("click",".enp-question-image-upload",function(){imageUploadInput=e(this).siblings(".enp-question-image-upload__input"),imageUploadInput.trigger("click")}),e(document).on("change",".enp-question-image-upload__input",function(){imageSubmit=e(this).siblings(".enp-button__question-image-upload"),imageSubmit.trigger("click"),imageSubmit.siblings(".enp-question-image-alt__input").focus()}),_.templateSettings={interpolate:/\{\{(.+?)\}\}/g};var j=_.template(e("#question_template").html()),N=_.template(e("#question_image_template").html()),V=_.template(e("#question_image_upload_button_template").html()),J=_.template(e("#question_image_upload_template").html()),k=_.template(e("#mc_option_template").html());e(".enp-question-content").each(function(t){n(e(this)),0===e(".enp-question-image",this).length&&e(".enp-question-image__input",this).after(V())})});